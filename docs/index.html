<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <script src="/js/blockly_node_javascript_cn.js"></script>
  <script src="https://unpkg.com/spritejs/dist/spritejs.min.js"></script>
  <script src="/js/spritly.js"></script>
  <style>
    html, body {
      width: 100%;
      min-width: 1000px;
      height: 100%;
      padding: 0;
      margin: 0;
    }
    #main {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: space-between;
    }
    #controls {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 9999;
    }
    #blocklyDiv {
      height: 100%;
      width: 38%;
      min-width: 560px;
      border: none;
    }
    #displayDiv {
      width: 62%;
      margin-left: 20px;      
    }
    #stage {
      height: 70%;
      background: url(res/img/grid.jpg) repeat;
    }
    #stage iframe {
      width: 100%;
      height: 100%;
    }
    #links {
      padding: 30px;
      display: flex;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="showXml()">Blocks</button>
    <button onclick="showCode()">Code</button>
    <button onclick="window.frames[0].location.href = `sandbox.html?t=${Date.now()}`">Run</button>
  </div>
  <div id="main">
    <div id="blocklyDiv"></div>
    <div id="displayDiv">
      <div id="stage">
        <iframe frameborder="no"></iframe>
      </div>
      <div id="links">
        <a href="#index">index</a>
      </div>
    </div>
  </div>

  <xml id="toolbox" style="display: none">
    <category name="Signals" colour="%{BKY_SIGNALS_HUE}">
      <block type="signal_do"></block>
      <block type="signal_new_sprite_as_receiver"></block>
      <block type="signal_when_receiver_is"></block>
      <block type="signal_onevent_send">
        <value name="SPRITE">
          <block type="sprite"></block>
        </value>   
      </block>
      <block type="get_data"></block>
      <block type="get_data_prop"></block>
    </category>
    <category name="Sprites" colour="%{BKY_SPRITE_HUE}">
      <block type="sprite"></block>
      <block type="sprite_attrs">
        <value name="SPRITE">
          <block type="sprite"></block>
        </value>        
      </block>
      <block type="sprite_append_to">
        <value name="SPRITE">
          <block type="sprite"></block>
        </value>
      </block>
      <block type="sprite_create_attrs"></block>
      <block type="sprite_each_elements_named"></block>
      <block type="sprite_get_attr">      
      </block>
      <block type="sprite_destroy">
        <value name="SPRITE">
          <block type="sprite"></block>
        </value>  
      </block>
    </category>
    <category name="Attributes">
      <category name="Common" colour="%{BKY_ATTRS_HUE}">
          <block type="field_attr_inc">
            <value name="VALUE">
              <block type="number">
                <field name="NUM">1</field>
              </block>
            </value>    
          </block>
          <block type="field_attr_anchor">
              <value name="VALUE">
                  <block type="number">
                    <field name="NUM">0.5</field>
                  </block>
              </value>          
          </block>
          <block type="field_attr_xy">
            <value name="VALUE">
              <block type="number">
                <field name="NUM">0</field>
              </block>
            </value>
          </block>
          <block type="field_attr_size">
            <value name="VALUE">
                <block type="number">
                  <field name="NUM">100</field>
                </block>
            </value>
          </block>
          <block type="field_attr_bgcolor">
            <value name="VALUE">
                <block type="colour_picker"></block>
            </value>
          </block>
          <block type="field_attr_opacity">
            <value name="VALUE">
                <block type="number">
                  <field name="NUM">0.5</field>
                </block>
            </value>
          </block>
          <block type="field_attr_scale">
              <value name="VALUE">
                  <block type="number">
                    <field name="NUM">1</field>
                  </block>
              </value>          
          </block>
          <block type="field_attr_translate">
              <value name="VALUE">
                  <block type="number">
                    <field name="NUM">10</field>
                  </block>
              </value>          
          </block>
          <block type="field_attr_skew">
              <value name="VALUE">
                  <block type="number">
                    <field name="NUM">0</field>
                  </block>
              </value>          
          </block>
          <block type="field_attr_rotate">
            <value name="VALUE">
                <block type="number">
                  <field name="NUM">0</field>
                </block>
            </value>
          </block>
          <block type="field_attr_borderRadius">
            <value name="VALUE">
                <block type="number">
                  <field name="NUM">0</field>
                </block>
            </value>          
          </block>
          <block type="field_attr_borderStyle"></block>
          <block type="field_attr_borderWidth">
            <value name="VALUE">
              <block type="number">
                <field name="NUM">1</field>
              </block>
            </value>            
          </block>
          <block type="field_attr_borderColour">
            <value name="VALUE">
              <block type="colour_picker">
                <field name="COLOUR">#000000</field>
              </block>
            </value>            
          </block>
          <block type="field_attr_dashOffset">
              <value name="VALUE">
                  <block type="number">
                    <field name="NUM">50</field>
                  </block>
              </value>             
          </block>
      </category>
      <category name="Sprite" colour="%{BKY_ATTRS_SPRITE_HUE}">
          <block type="field_attr_texture">
            <value name="VALUE">
                <block type="string">
                  <field name="TEXT">https://p0.ssl.qhimg.com/t01a72262146b87165f.png</field>
                </block>
            </value>              
          </block>
      </category>
      <category name="Label" colour="%{BKY_ATTRS_LABEL_HUE}">
        <block type="field_attr_text">
          <value name="VALUE">
              <block type="string">
                <field name="TEXT">Hello</field>
              </block>
          </value>
        </block>
        <block type="field_attr_fontFamily">
            <value name="VALUE">
                <block type="string">
                  <field name="TEXT">宋体</field>
                </block>
            </value>          
        </block>
        <block type="field_attr_fontSize">
            <value name="VALUE">
                <block type="number">
                  <field name="NUM">32</field>
                </block>
            </value>          
        </block>
        <block type="field_attr_fontWeight"></block>
        <block type="field_attr_fontStyle"></block>
        <block type="field_attr_fontVariant"></block>
        <block type="field_attr_textAlign"></block>
        <block type="field_attr_lineHeight">
            <value name="VALUE">
                <block type="number">
                  <field name="NUM">40</field>
                </block>
            </value>          
        </block>
        <block type="field_attr_strokeColour">
          <value name="VALUE">
            <block type="colour_picker"></block>
          </value>
        </block>
        <block type="field_attr_fillColour">
          <value name="VALUE">
            <block type="colour_picker"></block>
          </value>
        </block>
      </category>
      <category name="Path" colour="%{BKY_ATTRS_Path_HUE}">
        <block type="field_attr_d">
          <value name="VALUE">
            <block type="string">
              <field name="TEXT">M0,0L0,100L100,100z</field>
            </block>
          </value>
        </block>
        <block type="field_attr_lineWidth">
            <value name="VALUE">
                <block type="number">
                  <field name="NUM">4</field>
                </block>
            </value>          
        </block>
        <block type="field_attr_lineDash">
            <value name="VALUE">
                <block type="string">
                  <field name="TEXT">5,10</field>
                </block>
            </value>          
        </block>
        <block type="field_attr_lineDashOffset">
          <value name="VALUE">
              <block type="number">
                <field name="NUM">50</field>
              </block>
          </value>          
      </block>
        <block type="field_attr_lineCap"></block>
        <block type="field_attr_lineJoin"></block>
        <block type="field_attr_bounding"></block>
        <block type="field_attr_strokeColour">
          <value name="VALUE">
            <block type="colour_picker"></block>
          </value>
        </block>
        <block type="field_attr_fillColour">
          <value name="VALUE">
            <block type="colour_picker"></block>
          </value>
        </block>
      </category>
    </category>
    <category name="Anim & Async" colour="%{BKY_ANIMATE_HUE}">
      <block type="sprite_animate">
        <value name="SPRITE">
          <block type="sprite"></block>
        </value>
        <value name="DURATION">
          <block type="number">
            <field name="NUM">0.6</field>
          </block>
        </value>
        <value name="EASING">
          <block type="easing"></block>
        </value>
      </block>
      <block type="await"></block>
      <block type="await_frame"></block>
      <block type="easing"></block>
      <block type="bezier_easing"></block>
    </category>
    <category name="Getter & Setter" colour="%{BKY_GETTER_SETTER_HUE}">
      <block type="key_value"></block>
      <block type="object_get_prop"></block>
    </category>
    <category name="Literals" colour="%{BKY_LITERAL_HUE}">
      <block type="nil"></block>
      <block type="boolean"></block>
      <block type="number">
        <field name="NUM">123</field>
      </block>
      <block type="string">
        <field name="TEXT">Hello</field>
      </block>
      <block type="colour_picker"></block>
    </category>
    <category name="Lists" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_empty"></block>
      <block type="lists_repeat"></block>
      <block type="lists_create_with"></block>
      <block type="lists_reverse"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_length"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_number_property"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_modulo"></block>
      <block type="random_string"></block>
      <block type="math_random_int">
        <value name="FROM">
          <block type="number">
            <field name="NUM">0</field>
          </block>          
        </value>
        <value name="TO">
          <block type="number">
            <field name="NUM">10</field>
          </block>          
        </value>
      </block>
      <block type="math_random_float"></block>
      <block type="random_colour_rgb"></block>
      <block type="random_colour_hue"></block>
    </category>
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
    </category>
    <category name="Flows" colour="%{BKY_FLOWS_HUE}">
      <block type="controls_if"></block>
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="list_foreach"></block>
      <block type="list_index"></block>
      <block type="list_item"></block>
    </category>
    <category name="Log" colour="%{BKY_LOG_HUE}">
      <block type="log_log"></block>
      <block type="log_alert"></block>
    </category>
  </xml>

  <script>
  (async function () {
    const {Blockly, initWorkspace, Dropdown} = spritly;

    function loadStartBlocks() {
      const hash = window.location.hash || '#';
      const blockFile = hash.slice(1) || 'index';
      return fetch(`blocks/${blockFile}.xml`)
        .then(res => res.text())
        .then(str => (new DOMParser()).parseFromString(str, 'text/xml'));
    }

    const workspace = initWorkspace('blocklyDiv',
      {
        media: 'res/media/',
        toolbox: document.getElementById('toolbox'),
        grid: {spacing: 25,
          length: 3,
          colour: '#ccc',
          snap: true,
        },
        zoom: {
          controls: true,
          wheel: true,
        },
      });

    window.workspace = workspace;

    function getCode() {
      const xml = Blockly.Xml.workspaceToDom(workspace);
      // Add each top block one by one and generate code.
      const allCode = [];

      const signal_lists = xml.querySelectorAll('block[type="signal_onevent_send"] > field[name="SIGNAL"]');
      signal_lists.forEach((sig) => {
        Dropdown.set('Signals', sig.textContent);
      });

      const sprite_name_lists = xml.querySelectorAll('block[type="sprite_create_attrs"] > field[name="NAME"]');
      sprite_name_lists.forEach((name) => {
        Dropdown.set('SpriteNames', name.textContent);
      });

      const foreach_items = xml.querySelectorAll('block[type="list_foreach"] > field[name="ITEM"]');
      foreach_items.forEach((name) => {
        Dropdown.set('ListItems', name.textContent);
      });

      // Find and remove all top blocks.
      const topBlocks = [];
      for(let i = xml.childNodes.length - 1; i >= 0; i--) {
        const block = xml.childNodes[i];
        // console.log(block.lastChild);
        if(block.tagName === 'BLOCK') {
          const type = block.getAttribute('type');
          xml.removeChild(block);
          if(type === 'signal_do') {
            const signal = block.querySelector('field').textContent || 'START';
            topBlocks.unshift({block, type, signal, id: ''});
          } else if(type === 'signal_new_sprite_as_receiver') {
            const signal = block.querySelector('field[name="SIGNAL"]').textContent || 'START';
            const nodeType = block.querySelector('field[name="RECEIVER"]').textContent || 'Sprite';
            const id = block.querySelector('field[name="ID"]').textContent;
            Dropdown.set('Sprites', id);
            allCode.push(`utils.Signal.listen('${signal}', {id: '${id}', $$creator: '${nodeType}'});\n`);
            topBlocks.unshift({block, type, signal, id});
          } else if(type === 'signal_when_receiver_is') {
            const signal = block.querySelector('field[name="SIGNAL"]').textContent || 'START';
            const id = block.querySelector('field[name="ID"]').textContent;
            topBlocks.unshift({block, type, signal, id});
          }
        }
      }
      // Generate JavaScript code and run it.
      window.LoopTrap = 1e7;
      Blockly.JavaScript.INFINITE_LOOP_TRAP = `${Blockly.Generator.prototype.INDENT}if (--window.LoopTrap == 0) throw "Infinite loop.";\n`;

      for(let i = 0; i < topBlocks.length; i++) {
        const {block, signal, id} = topBlocks[i];
        const headless = new Blockly.Workspace();
        xml.appendChild(block);
        Blockly.Xml.domToWorkspace(xml, headless);
        const indent = Blockly.Generator.prototype.INDENT + Blockly.Generator.prototype.INDENT;
        const code = indent + Blockly.JavaScript.workspaceToCode(headless).split(/\n/g)
          .join(`\n${indent}`).trimRight();
        allCode.push(`utils.Signal.on('${signal}', async function({signal, sender, receiver, data, target}){
  if(receiver.id === '${id}' || !'${id}' && receiver === utils.Signal.DEFAULT_SIGNAL || target === receiver){
    if(receiver.$$creator) {
      receiver.$$target = spritejs.createElement(receiver.$$creator, {id: '${id}'});
      utils.ElementList.add(receiver.$$target);
      delete receiver.$$creator;
    }
    if(receiver.$$target) {
      receiver = receiver.$$target;
    }
    if(data[utils.Symbols.target] != null) {
      target = data.target;
    }
    if(target == null) {
      if(receiver && receiver !== utils.Signal.DEFAULT_SIGNAL) target = receiver;
      else target = sender;
    }
${code}
  }
});`);
        headless.dispose();
        xml.removeChild(block);
      }
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      allCode.push("utils.Signal.send('START');\n");
      /* eslint-disable */
      allCode.unshift(`/** 
  Generated by spritly
  Usage: 
  <script src="https://unpkg.com/spritejs/dist/spritejs.min.js"><\/script>
  <script src="https://unpkg.com/spritly/dist/utils.min.js"><\/script>
*/`); /* eslint-enable */
      return allCode;
    }

    function showXml() {
      const xml = Blockly.Xml.workspaceToDom(workspace);
      const code = xml.outerHTML;
      let indent = 0;
      let code2 = code.replace(/></g, '>\n<');
      code2 = code2.split(/\n/g).map((line) => {
        let ret = '';
        if(indent > 0) {
          ret = `${(new Array(indent + 1)).join(' ')}${line}`;
        }
        if(/^<\//.test(line)) {
          indent -= 2;
        } else if(!(/<\/\w+>$/.test(line))) {
          indent += 2;
        }
        return ret;
      }).join('\n');
      const wnd = window.open('', '__blank', '');
      wnd.document.write(`<pre class="prettyprint" lang-xml>${code2.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`);
      wnd.document.write('<script>const sel = document.createElement("script"); sel.src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"; window.onload = function(){document.body.appendChild(sel)};<\/script>'); // eslint-disable-line
      wnd.document.close();
    }

    function showCode() {
      // Generate JavaScript code and display it.
      const code = getCode().join('\n\n');
      const wnd = window.open('', '__blank', '');
      wnd.document.write(`<pre class="prettyprint" lang-js>${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`);
      wnd.document.write('<script>const sel = document.createElement("script"); sel.src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"; window.onload = function(){document.body.appendChild(sel)};<\/script>'); // eslint-disable-line
      wnd.document.close();
    }

    function runCode() {
      try {
        Dropdown.clear();
        const codes = getCode();
        const code = codes.join('');
        window.frames[0].exec(code);
      } catch (e) {
        console.error(e);
        // alert(e);
      }
    }

    window.runCode = runCode;
    window.showCode = showCode;
    window.showXml = showXml;

    const block = await loadStartBlocks();
    Blockly.Xml.domToWorkspace(block.documentElement,
      workspace);

    function debounce(action, delay = 300) {
      let timer = null;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => {
          action.apply(this, args);
        }, delay);
      };
    }

    const update = debounce(() => {
      window.frames[0].location.href = `sandbox.html?t=${Date.now()}`;
    });

    workspace.addChangeListener((event) => {
      if(event.type === Blockly.Events.CHANGE
      || event.type === Blockly.Events.CREATE
      || event.type === Blockly.Events.DELETE
      || event.type === Blockly.Events.MOVE && event.oldParentId !== event.newParentId) {
        update();
      }
    });
    update();

    const links = document.getElementById('links');
    links.addEventListener('click', async (evt) => {
      evt.preventDefault();
      if(evt.target.tagName === 'A') {
        const link = evt.target;
        window.location.href = link.href;
        const block = await loadStartBlocks();
        workspace.clear();
        Blockly.Xml.domToWorkspace(block.documentElement,
          workspace);
      }
    });
  }());
  </script>
</body>
</html>